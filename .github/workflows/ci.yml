name: CI

env:
  PYTHONUNBUFFERED: 1

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  ci:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-2019, macos-10.15]
        architecture: [x64]
        python-version: ['3.7']
        include:
          - architecture: x86
            os: windows-2019
          - python-version: '3.8'
            os: ubuntu-latest
          - python-version: '3.9'
            os: ubuntu-latest
          - python-version: '3.10'
            os: ubuntu-latest
      fail-fast: false

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.architecture }}

    - name: Setup SDR Drivers (Win)
      if: startsWith(matrix.os, 'windows')
      run: |
        git clone --depth 1 https://gitlab.com/jopohl/sdr_drivers
        if ("$env:PYARCH" -eq "x86") {
        echo "Using 32-bit SDR libraries..."
        Copy-Item "sdr_drivers\win-32.zip" -Destination "C:\windlls.zip"
        }
        else {
        echo "Using 64-bit SDR libraries..."
        Copy-Item "sdr_drivers\win-64.zip" -Destination "C:\windlls.zip"
        }
        Copy-Item "sdr_drivers\*.whl"  -Destination "C:\"
      shell: powershell
      env:
        PYARCH: ${{ matrix.architecture }}


    - name: Setup SDR Drivers (mac)
      if: startsWith(matrix.os, 'macos')
      run: |
        git clone --depth 1 https://gitlab.com/jopohl/sdr_drivers
        mkdir src/urh/dev/native/lib/shared
        tar xf sdr_drivers/osx-64.tar.bz2 -C src/urh/dev/native/lib/shared
        mkdir /tmp/osx-64
        tar xf sdr_drivers/osx-64.tar.bz2 -C /tmp/osx-64
        rm -rf sdr_drivers
